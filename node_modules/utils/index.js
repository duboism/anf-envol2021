// Module utils

const stream = require('stream');
const fs = require('fs');

function loadFile(filename) {
    return (req, res) => {
        let file = fs.createReadStream(filename);
        stream.pipeline(file, res, (error) => {
            if (error) console.log(error);
        });
    };
}

function register(filename) {
    return (req, res, next) => {
        req.on('data', (chunk) => {
            let s = chunk.toString();
            console.log(s);
            // Récupère les valeurs
            vals = {};
            for (paramval of s.split("&")) {
                [k, v] = paramval.split("=");
                vals[k] = decodeURIComponent(v);
            }
            console.log(vals)
            // Formate une ligne CSV
            data = Object.values(vals).join("\t") + "\n";
            // ajout dans le fichier
            fs.appendFile(filename, data, (error) => {
                if (error) console.log(error);
            });
        });
        next();
    };
};

module.exports.loadFile = loadFile;
module.exports.register = register;
